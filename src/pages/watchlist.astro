---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.svelte';
---

<Layout title="My Watchlist - Tsukino">
  <Navbar client:load />
  
  <main class="container watchlist-page">
    <h1>My Watchlist</h1>
    
    <div id="watchlist-content">
      <div class="loading">Loading watchlist...</div>
    </div>
  </main>
</Layout>

<script>
  import { getWatchlist, removeFromWatchlist, getHistory } from '../lib/storage';
  
  function render() {
    const container = document.getElementById('watchlist-content');
    if (!container) return;
    
    const watchlist = getWatchlist();
    const history = getHistory();
    
    if (watchlist.length === 0 && history.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="64" height="64">
            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
          </svg>
          <p>Your watchlist is empty</p>
          <span>Add anime to your watchlist to keep track of what you want to watch</span>
          <a href="/" class="btn btn-primary">Browse Anime</a>
        </div>
      `;
      return;
    }
    
    let html = '';
    
    // Watchlist Section
    if (watchlist.length > 0) {
      html += `
        <section class="watchlist-section">
          <h2>üìö Saved (${watchlist.length})</h2>
          <div class="watchlist-grid">
            ${watchlist.map(item => `
              <div class="watchlist-item" data-id="${item.id}">
                <a href="/anime/${item.id}" class="item-link">
                  <img src="${item.image}" alt="${item.title}" />
                  <div class="item-info">
                    <h3>${item.title}</h3>
                    <span class="item-date">Added ${new Date(item.addedAt).toLocaleDateString()}</span>
                  </div>
                </a>
                <button class="remove-btn" data-id="${item.id}" title="Remove from watchlist">
                  <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                  </svg>
                </button>
              </div>
            `).join('')}
          </div>
        </section>
      `;
    }
    
    // History Section
    if (history.length > 0) {
      html += `
        <section class="history-section">
          <h2>üïê Recently Watched</h2>
          <div class="history-grid">
            ${history.slice(0, 10).map(item => `
              <a href="/watch/${item.episodeId}" class="history-item">
                <img src="${item.animeImage}" alt="${item.animeTitle}" />
                <div class="history-info">
                  <h4>${item.animeTitle}</h4>
                  <span>Episode ${item.episodeNumber}</span>
                </div>
              </a>
            `).join('')}
          </div>
        </section>
      `;
    }
    
    container.innerHTML = html;
    
    // Add remove button handlers
    container.querySelectorAll('.remove-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const id = (btn as HTMLButtonElement).dataset.id;
        if (id) {
          removeFromWatchlist(id);
          render();
        }
      });
    });
  }
  
  render();
</script>

<style>
  .watchlist-page {
    padding-top: var(--spacing-xl);
    padding-bottom: var(--spacing-2xl);
    min-height: 80vh;
  }
  
  .watchlist-page h1 {
    margin-bottom: var(--spacing-xl);
  }
  
  .loading {
    color: var(--color-text-muted);
    text-align: center;
    padding: var(--spacing-2xl);
  }
  
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-md);
    padding: var(--spacing-2xl);
    text-align: center;
    color: var(--color-text-muted);
  }
  
  .empty-state svg {
    opacity: 0.5;
  }
  
  .empty-state span {
    font-size: 0.875rem;
    max-width: 300px;
  }
  
  .watchlist-section,
  .history-section {
    margin-bottom: var(--spacing-2xl);
  }
  
  .watchlist-section h2,
  .history-section h2 {
    font-size: 1.25rem;
    margin-bottom: var(--spacing-lg);
  }
  
  .watchlist-grid {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
  }
  
  .watchlist-item {
    display: flex;
    align-items: center;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    overflow: hidden;
    transition: all var(--transition-fast);
  }
  
  .watchlist-item:hover {
    border-color: var(--color-border-hover);
  }
  
  .item-link {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    flex: 1;
    padding: var(--spacing-sm);
    text-decoration: none;
  }
  
  .watchlist-item img {
    width: 60px;
    height: 80px;
    object-fit: cover;
    border-radius: var(--radius-sm);
  }
  
  .item-info h3 {
    font-size: 0.95rem;
    color: var(--color-text-primary);
    margin-bottom: 4px;
  }
  
  .item-date {
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }
  
  .remove-btn {
    padding: var(--spacing-md);
    background: transparent;
    border: none;
    color: var(--color-text-muted);
    cursor: pointer;
    transition: color var(--transition-fast);
  }
  
  .remove-btn:hover {
    color: #ef4444;
  }
  
  .history-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: var(--spacing-md);
  }
  
  .history-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm);
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: all var(--transition-fast);
  }
  
  .history-item:hover {
    background: var(--color-bg-glass);
    border-color: var(--color-accent);
  }
  
  .history-item img {
    width: 45px;
    height: 60px;
    object-fit: cover;
    border-radius: var(--radius-sm);
  }
  
  .history-info h4 {
    font-size: 0.8rem;
    color: var(--color-text-primary);
    margin-bottom: 2px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .history-info span {
    font-size: 0.7rem;
    color: var(--color-accent);
  }
</style>
