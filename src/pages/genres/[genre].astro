---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import Navbar from "../../components/Navbar.svelte";
import AnimeCard from "../../components/AnimeCard.svelte";
import { getByGenre } from "../../lib/api";

const { genre } = Astro.params;

if (!genre) {
    return Astro.redirect("/genres");
}

const url = new URL(Astro.request.url);
const page = parseInt(url.searchParams.get("page") || "1");

const genreTitle =
    genre.charAt(0).toUpperCase() + genre.slice(1).replace(/-/g, " ");

let data;
let error = false;

try {
    data = await getByGenre(genre, page);
} catch (e) {
    error = true;
}

const anime = data?.results || [];
const hasNextPage = data?.hasNextPage || false;
---

<Layout title={`${genreTitle} Anime - Tsukino`}>
    <Navbar client:load />

    <main class="container browse-page">
        <header class="page-header">
            <a href="/genres" class="back-link">← All Genres</a>
            <h1>{genreTitle}</h1>
            <p class="subtitle">Browse all {genreTitle.toLowerCase()} anime</p>
        </header>

        {
            error ? (
                <div class="error-state">
                    <p>Failed to load anime. Please try again.</p>
                    <a href={`/genres/${genre}`} class="btn btn-primary">
                        Retry
                    </a>
                </div>
            ) : (
                <>
                    <div class="anime-grid">
                        {anime.map((item: any) => (
                            <AnimeCard
                                id={item.id}
                                title={item.title}
                                image={item.image}
                                type={item.type}
                                releaseDate={item.releaseDate}
                            />
                        ))}
                    </div>

                    {anime.length === 0 && (
                        <div class="empty-state">
                            <p>No anime found in this genre.</p>
                        </div>
                    )}

                    <div class="pagination">
                        {page > 1 && (
                            <a
                                href={`/genres/${genre}?page=${page - 1}`}
                                class="btn btn-ghost"
                            >
                                ← Previous
                            </a>
                        )}
                        <span class="page-info">Page {page}</span>
                        {hasNextPage && (
                            <a
                                href={`/genres/${genre}?page=${page + 1}`}
                                class="btn btn-primary"
                            >
                                Next →
                            </a>
                        )}
                    </div>
                </>
            )
        }
    </main>
</Layout>

<style>
    .browse-page {
        padding-top: var(--spacing-2xl);
        padding-bottom: var(--spacing-2xl);
        min-height: 100vh;
    }

    .page-header {
        margin-bottom: var(--spacing-xl);
    }

    .back-link {
        display: inline-block;
        color: var(--color-text-secondary);
        text-decoration: none;
        font-size: 0.875rem;
        margin-bottom: var(--spacing-sm);
    }

    .back-link:hover {
        color: var(--color-accent);
    }

    .page-header h1 {
        font-size: 2rem;
        font-weight: 800;
        margin-bottom: var(--spacing-sm);
    }

    .subtitle {
        color: var(--color-text-secondary);
    }

    .anime-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: var(--spacing-md);
        margin-top: var(--spacing-xl);
    }

    .page-info {
        color: var(--color-text-secondary);
        font-size: 0.875rem;
    }

    .error-state,
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-2xl);
        color: var(--color-text-muted);
    }
</style>
