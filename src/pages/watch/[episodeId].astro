---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import Navbar from "../../components/Navbar.svelte";
import VideoPlayer from "../../components/VideoPlayer.svelte";
import {
  getEpisodeSources,
  getAnimeInfo,
  getEpisodeServers,
} from "../../lib/api";

const { episodeId } = Astro.params;

if (!episodeId) {
  return Astro.redirect("/");
}

let sources: any = null;
let servers: any[] = [];
let anime: any = null;
let currentEpisode: any = null;
let error = false;
let isDubAvailable = false;

try {
  // Fetch episode sources and servers in parallel
  const [sourcesData, serversData] = await Promise.all([
    getEpisodeSources(episodeId),
    getEpisodeServers(episodeId).catch(() => []),
  ]);

  sources = sourcesData;
  servers = serversData;

  // Extract anime ID from episode ID (format: anime-id$ep=N$token=xxx)
  const animeId = episodeId.split("$")[0];
  if (animeId) {
    anime = await getAnimeInfo(animeId).catch(() => null);
    if (anime?.episodes) {
      currentEpisode = anime.episodes.find((ep: any) => ep.id === episodeId);
      // Check if any episode has dub
      isDubAvailable = anime.episodes.some((ep: any) => ep.isDubbed);
    }
  }
} catch (e) {
  console.error("[Watch] Error fetching sources:", e);
  error = true;
}

// Get all video sources
const videoSources = sources?.sources || [];
const subtitles =
  sources?.subtitles?.filter((s: any) => s.kind === "captions") || [];
const headers = sources?.headers || {};
const externalUrl = currentEpisode?.url || null;

// Find download URL if available
const downloadUrl = sources?.download || "";

// For HLS streams, check if we have a valid source
const hasValidSource = videoSources.length > 0 && !error;

// Generate proxied URL to handle CORS/Referer issues
const referer = headers.Referer || "https://megacloud.tv/";
---

<Layout title={`Watch ${anime?.title || "Episode"} - Tsukino`}>
  <Navbar client:load />

  <main class="watch-page">
    <div class="player-section">
      <div class="player-container" id="player-container">
        {
          error || !hasValidSource ? (
            <div class="player-error">
              <svg
                viewBox="0 0 24 24"
                fill="currentColor"
                width="48"
                height="48"
              >
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm0-4h-2V7h2v6z" />
              </svg>
              <p>Unable to load video source</p>
              <p class="error-hint">
                This may be due to regional restrictions or the source being
                unavailable.
              </p>
              {externalUrl && (
                <a
                  href={externalUrl}
                  target="_blank"
                  rel="noopener"
                  class="btn btn-primary"
                >
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    width="18"
                    height="18"
                  >
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3" />
                  </svg>
                  Watch on External Site
                </a>
              )}
              <a href="/" class="btn btn-ghost">
                Back to Home
              </a>
            </div>
          ) : (
            <VideoPlayer
              client:load
              sources={videoSources}
              servers={servers}
              subtitles={subtitles}
              episodeId={episodeId}
              referer={referer}
              isDubAvailable={isDubAvailable}
              externalUrl={externalUrl || ""}
              downloadUrl={downloadUrl}
            />
          )
        }
      </div>

      <div class="player-controls-bar">
        <div class="episode-nav">
          {
            anime?.episodes &&
              currentEpisode &&
              (() => {
                const currentIndex = anime.episodes.findIndex(
                  (ep: any) => ep.id === episodeId,
                );
                const prevEpisode =
                  currentIndex > 0 ? anime.episodes[currentIndex - 1] : null;
                const nextEpisode =
                  currentIndex < anime.episodes.length - 1
                    ? anime.episodes[currentIndex + 1]
                    : null;

                return (
                  <>
                    {prevEpisode && (
                      <a
                        href={`/watch/${prevEpisode.id}`}
                        class="btn btn-ghost"
                      >
                        <svg
                          viewBox="0 0 24 24"
                          fill="currentColor"
                          width="16"
                          height="16"
                        >
                          <path d="M15 19l-7-7 7-7v14z" />
                        </svg>
                        Previous
                      </a>
                    )}
                    {nextEpisode && (
                      <a
                        href={`/watch/${nextEpisode.id}`}
                        class="btn btn-primary"
                      >
                        Next
                        <svg
                          viewBox="0 0 24 24"
                          fill="currentColor"
                          width="16"
                          height="16"
                        >
                          <path d="M9 5l7 7-7 7V5z" />
                        </svg>
                      </a>
                    )}
                  </>
                );
              })()
          }
        </div>
      </div>
    </div>

    <div class="container watch-info">
      <div class="info-section">
        {
          anime && (
            <div class="anime-header">
              <a href={`/anime/${anime.id}`} class="anime-link">
                <img src={anime.image} alt={anime.title} class="anime-thumb" />
                <div>
                  <h1>{anime.title}</h1>
                  {currentEpisode && (
                    <p class="episode-label">
                      Episode {currentEpisode.number}
                      {currentEpisode.title ? `: ${currentEpisode.title}` : ""}
                    </p>
                  )}
                </div>
              </a>
            </div>
          )
        }
      </div>

      {
        anime?.episodes && anime.episodes.length > 0 && (
          <div class="episodes-sidebar">
            <h3>Episodes</h3>
            <div class="episodes-list">
              {anime.episodes.map((ep: any) => (
                <a
                  href={`/watch/${ep.id}`}
                  class={`episode-item ${ep.id === episodeId ? "active" : ""}`}
                >
                  <span class="ep-num">{ep.number}</span>
                  <span class="ep-title">
                    {ep.title || `Episode ${ep.number}`}
                  </span>
                  {ep.isDubbed && <span class="dub-badge">DUB</span>}
                </a>
              ))}
            </div>
          </div>
        )
      }
    </div>
  </main>
</Layout>

<style>
  .watch-page {
    min-height: 100vh;
    background: #000;
  }

  .player-section {
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
  }

  .player-container {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9;
    background: #000;
  }

  .player-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    gap: var(--spacing-md);
    color: var(--color-text-muted);
    text-align: center;
    padding: var(--spacing-lg);
  }

  .player-error svg {
    color: #ef4444;
  }

  .error-hint {
    font-size: 0.875rem;
    max-width: 400px;
  }

  .player-controls-bar {
    display: flex;
    justify-content: flex-end;
    padding: var(--spacing-md);
    background: var(--color-bg-secondary);
  }

  .episode-nav {
    display: flex;
    gap: var(--spacing-sm);
  }

  .watch-info {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: var(--spacing-xl);
    padding-top: var(--spacing-xl);
    padding-bottom: var(--spacing-2xl);
    background: var(--color-bg-primary);
  }

  .anime-header {
    margin-bottom: var(--spacing-lg);
  }

  .anime-link {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    text-decoration: none;
  }

  .anime-thumb {
    width: 80px;
    height: 110px;
    object-fit: cover;
    border-radius: var(--radius-md);
  }

  .anime-link h1 {
    font-size: 1.5rem;
    color: var(--color-text-primary);
    margin-bottom: 4px;
  }

  .episode-label {
    color: var(--color-accent);
    font-size: 0.875rem;
  }

  .episodes-sidebar {
    background: var(--color-bg-secondary);
    border-radius: var(--radius-lg);
    padding: var(--spacing-md);
    max-height: 500px;
    overflow-y: auto;
  }

  .episodes-sidebar h3 {
    font-size: 1rem;
    margin-bottom: var(--spacing-md);
    padding-bottom: var(--spacing-sm);
    border-bottom: 1px solid var(--color-border);
  }

  .episodes-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .episode-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm);
    border-radius: var(--radius-sm);
    text-decoration: none;
    transition: background var(--transition-fast);
  }

  .episode-item:hover {
    background: var(--color-bg-glass);
  }

  .episode-item.active {
    background: var(--color-accent-glow);
    border-left: 3px solid var(--color-accent);
  }

  .ep-num {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-bg-card);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--color-text-secondary);
    flex-shrink: 0;
  }

  .episode-item.active .ep-num {
    background: var(--color-accent);
    color: var(--color-bg-primary);
  }

  .ep-title {
    flex: 1;
    font-size: 0.8rem;
    color: var(--color-text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .dub-badge {
    font-size: 0.625rem;
    padding: 2px 6px;
    background: #3b82f6;
    color: white;
    border-radius: 4px;
    font-weight: 600;
  }

  @media (max-width: 900px) {
    .watch-info {
      grid-template-columns: 1fr;
    }

    .episodes-sidebar {
      max-height: 300px;
    }
  }
</style>
